# ADR 003: RFC 7807 Problem Details for HTTP APIs

## Status

Accepted

## Context

RegistryAccord APIs need a standardized approach to error reporting that provides consistent, machine-readable error information to clients. Without a standard format, clients must implement custom error handling for each API, leading to:

1. **Inconsistent error handling**: Different APIs return errors in different formats
2. **Poor developer experience**: Clients cannot programmatically handle errors
3. **Limited debugging information**: Insufficient context for troubleshooting
4. **Missing correlation**: No way to trace errors across systems

We evaluated several error reporting approaches:

- **Ad-hoc JSON errors**: Custom error formats per API
- **HTML error pages**: Human-readable but not machine-processable
- **RFC 7807**: Standardized problem details format
- **Custom XML errors**: Verbose and not widely supported

## Decision

We will implement **RFC 7807 Problem Details** for all RegistryAccord API error responses.

### Implementation Details

1. **Standard Fields** (per RFC 7807):
   - `type`: URI reference that identifies the problem type
   - `title`: Short, human-readable summary of the problem
   - `status`: HTTP status code generated by the origin server
   - `detail`: Human-readable explanation specific to this occurrence
   - `instance`: URI reference that identifies the specific occurrence

2. **RegistryAccord Extensions**:
   - `trace_id`: Unique identifier for tracing errors across systems
   - `error_code`: RegistryAccord-specific error code for programmatic handling
   - `details`: Additional structured information about the error

3. **Content Type**:
   - `application/problem+json` for JSON responses
   - `application/problem+xml` for XML responses (if needed)

4. **Error Types**:
   - Standard HTTP error types
   - RegistryAccord-specific types under `https://api.registryaccord.com/errors/`

## Consequences

### Positive

- **Standardization**: Consistent error format across all APIs
- **Machine-readable**: Clients can programmatically handle errors
- **Rich debugging**: Detailed information for troubleshooting
- **Traceability**: Correlation IDs enable cross-system tracing
- **Extensibility**: Can add custom fields while maintaining compatibility

### Negative

- **Verbosity**: More detailed errors result in larger response bodies
- **Implementation overhead**: Need to map all errors to RFC 7807 format
- **Learning curve**: Developers need to understand the format

### Neutral

- **Client adoption**: Clients must be updated to handle RFC 7807 errors
- **Backward compatibility**: May break clients expecting custom error formats

## Examples

### Standard Error Response

```http
HTTP/1.1 400 Bad Request
Content-Type: application/problem+json
RA-API-Version: 2025-11-01
X-Correlation-ID: 550e8400-e29b-41d4-a716-446655440000

{
  "type": "https://api.registryaccord.com/errors/validation_failed",
  "title": "Validation Failed",
  "status": 400,
  "detail": "The provided email address is not valid",
  "instance": "/v1/identities",
  "trace_id": "550e8400-e29b-41d4-a716-446655440000",
  "error_code": "VALIDATION_FAILED",
  "details": {
    "field": "email",
    "value": "invalid-email",
    "constraint": "email_format"
  }
}
```

### Authentication Error

```http
HTTP/1.1 401 Unauthorized
Content-Type: application/problem+json
WWW-Authenticate: Bearer realm="registryaccord"
RA-API-Version: 2025-11-01
X-Correlation-ID: 550e8400-e29b-41d4-a716-446655440001

{
  "type": "https://api.registryaccord.com/errors/auth_failed",
  "title": "Authentication Failed",
  "status": 401,
  "detail": "The provided JWT token has expired",
  "instance": "/v1/sessions",
  "trace_id": "550e8400-e29b-41d4-a716-446655440001",
  "error_code": "AUTH_FAILED"
}
```

## References

- [RFC 7807](https://tools.ietf.org/html/rfc7807) - Problem Details for HTTP APIs
- [API Best Practices](https://opensource.zalando.com/restful-api-guidelines/#176)
- [Google API Design](https://cloud.google.com/apis/design/errors)
