name: Check Links
on:
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  workflow_dispatch:
  pull_request:
    paths:
      - '**/*.md'
      - '**/*.yaml'

permissions:
  contents: read
  issues: write
  pull-requests: write
  id-token: write

jobs:
  link-check:
    name: Check all links in documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Link Checker
        uses: lycheeverse/lychee-action@v2
        with:
          args: |
            --verbose
            --no-progress
            --accept 200,201,202,204,301,302,307,308
            --exclude-path node_modules
            --exclude-path vendor
            --exclude 'https://example.com'
            --exclude 'https://api.registryaccord.dev'
            --exclude 'https://api.registryaccord.com'
            '**/*.md'
            '**/*.yaml'
          fail: true
      
      - name: Create issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue list --state open --label broken-links --json title > issues.json
          if ! grep -q "ðŸ”— Broken links detected in documentation" issues.json; then
            gh issue create \
              --title "ðŸ”— Broken links detected in documentation" \
              --body "The automated link checker found broken links. Please review and fix them.\n\nRun locally: \`npx lychee **/*.md **/*.yaml\`" \
              --label "documentation,bug,broken-links"
          fi
