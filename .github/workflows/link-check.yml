name: Check Links
on:
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  workflow_dispatch:
  pull_request:
    paths:
      - '**/*.md'
      - '**/*.yaml'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  link-check:
    name: Check all links in documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Link Checker
        uses: lycheeverse/lychee-action@v1
        with:
          args: |
            --verbose
            --no-progress
            --accept 200,201,202,204,301,302,307,308
            --exclude-path node_modules
            --exclude-path vendor
            --exclude 'https://example.com'
            --exclude 'https://api.registryaccord.dev'
            --exclude 'https://api.registryaccord.com'
            '**/*.md'
            '**/*.yaml'
          fail: true
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links'
            });
            
            if (existingIssues.data.length === 0) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”— Broken links detected in documentation',
                body: 'The automated link checker found broken links. Please review and fix them.\n\nRun locally: `npx lychee **/*.md **/*.yaml`',
                labels: ['documentation', 'bug', 'broken-links']
              });
            }
